<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>AWS Notes API Tester</title>
  <style>
    :root {
      --bg: #05070b;
      --card-bg: #10131b;
      --accent: #1e90ff;
      --accent-soft: rgba(30, 144, 255, 0.12);
      --border: #262b3a;
      --text: #f5f5f5;
      --muted: #9ca3af;
      --danger: #f97373;
      --success: #4ade80;
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
    }

    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI",
        sans-serif;
      background: radial-gradient(circle at top, #111827 0, var(--bg) 70%);
      color: var(--text);
      min-height: 100vh;
      display: flex;
      justify-content: center;
      padding: 32px 12px;
    }

    .shell {
      width: 100%;
      max-width: 980px;
    }

    .card {
      background: linear-gradient(135deg, #0b1120, #020617);
      border-radius: 18px;
      padding: 24px 26px 22px;
      box-shadow: 0 24px 60px rgba(0, 0, 0, 0.7);
      border: 1px solid rgba(148, 163, 184, 0.15);
    }

    header h1 {
      margin: 0 0 4px;
      font-size: 24px;
    }

    header small {
      color: var(--muted);
      font-size: 13px;
    }

    header small strong {
      color: var(--accent);
    }

    .row {
      display: flex;
      flex-wrap: wrap;
      gap: 16px;
      margin-top: 18px;
    }

    .col {
      flex: 1 1 260px;
      min-width: 0;
    }

    label {
      display: block;
      font-size: 13px;
      margin-bottom: 4px;
      color: var(--muted);
    }

    .label-row {
      display: flex;
      justify-content: space-between;
      align-items: baseline;
      gap: 8px;
    }

    textarea,
    input {
      width: 100%;
      border-radius: 10px;
      border: 1px solid var(--border);
      background: rgba(15, 23, 42, 0.95);
      color: var(--text);
      font: 13px var(--mono);
      padding: 8px 10px;
      resize: vertical;
      min-height: 40px;
    }

    textarea:focus,
    input:focus {
      outline: none;
      border-color: var(--accent);
      box-shadow: 0 0 0 1px rgba(30, 144, 255, 0.4);
    }

    textarea.token {
      min-height: 82px;
      white-space: nowrap;
      overflow-x: auto;
    }

    textarea.note-text {
      min-height: 82px;
    }

    input.note-id {
      font-size: 12px;
    }

    .btn-row {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-top: 12px;
    }

    button {
      border-radius: 999px;
      border: 1px solid transparent;
      padding: 7px 14px;
      font-size: 13px;
      background: #111827;
      color: #e5e7eb;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      transition: background 0.12s ease, transform 0.08s ease, border 0.12s ease;
    }

    button span.hotkey {
      font-size: 11px;
      opacity: 0.7;
    }

    button.primary {
      background: var(--accent);
      color: white;
    }

    button.danger {
      background: rgba(239, 68, 68, 0.14);
      color: #fecaca;
      border-color: rgba(239, 68, 68, 0.5);
    }

    button.secondary {
      background: rgba(15, 23, 42, 0.9);
      border-color: var(--border);
    }

    button:hover {
      background: #1f2937;
      transform: translateY(-0.5px);
    }

    button.primary:hover {
      background: #1873cc;
    }

    button.danger:hover {
      background: rgba(239, 68, 68, 0.2);
    }

    button.secondary:hover {
      background: rgba(15, 23, 42, 1);
    }

    button:disabled {
      opacity: 0.55;
      cursor: default;
      transform: none;
    }

    .status-bar {
      margin-top: 14px;
      font-size: 12px;
      color: var(--muted);
      display: flex;
      justify-content: space-between;
      gap: 16px;
      flex-wrap: wrap;
    }

    .status-bar strong {
      font-weight: 600;
    }

    .status-bar .status-ok {
      color: var(--success);
    }

    .status-bar .status-error {
      color: var(--danger);
    }

    .status-bar code {
      font-family: var(--mono);
      font-size: 11px;
      background: rgba(15, 23, 42, 0.7);
      padding: 2px 4px;
      border-radius: 4px;
    }

    .response {
      margin-top: 16px;
      background: var(--card-bg);
      border-radius: 14px;
      border: 1px solid var(--border);
      padding: 12px 12px 10px;
      font-family: var(--mono);
      font-size: 12px;
      white-space: pre;
      color: #e5e7eb;
      overflow-x: auto;
      max-height: 360px;
    }

    .badge {
      display: inline-flex;
      align-items: center;
      border-radius: 999px;
      padding: 2px 8px;
      font-size: 11px;
      background: var(--accent-soft);
      color: #bfdbfe;
    }

    .badge-dot {
      width: 6px;
      height: 6px;
      border-radius: 999px;
      background: var(--accent);
      margin-right: 5px;
    }

    .hint {
      font-size: 11px;
      color: var(--muted);
      margin-top: 4px;
    }

    .hint code {
      font-family: var(--mono);
      background: rgba(15, 23, 42, 0.7);
      padding: 2px 4px;
      border-radius: 4px;
    }

    @media (max-width: 720px) {
      .card {
        padding: 18px 14px 14px;
      }

      header h1 {
        font-size: 20px;
      }

      .response {
        max-height: 260px;
      }
    }
  </style>
</head>
<body>
  <div class="shell">
    <div class="card">
      <header>
        <h1>AWS Notes API Tester</h1>
        <small>
          Backend:
          <strong>API Gateway</strong> + <strong>Lambda</strong> +
          <strong>DynamoDB</strong> + <strong>Cognito</strong>
        </small>
      </header>

      <div class="btn-row" style="margin-top: 14px;">
        <button id="btn-login" class="primary">
          Login with Cognito
        </button>
        <button id="btn-logout" class="secondary">
          Clear token
        </button>
      </div>

      <div class="row" style="margin-top: 18px;">
        <div class="col">
          <div class="label-row">
            <label for="token">Access Token (Bearer)</label>
            <span class="badge" id="api-url-badge">
              <span class="badge-dot"></span>
              <span>API: loading…</span>
            </span>
          </div>
          <textarea
            id="token"
            class="token"
            spellcheck="false"
            placeholder="Paste your Cognito ACCESS token here (or click Login above)…"
          ></textarea>
          <div class="hint">
            Saved in <code>localStorage</code> so you don't have to paste it every
            time.
          </div>
        </div>

        <div class="col">
          <label for="note-text">Note text</label>
          <textarea
            id="note-text"
            class="note-text"
            placeholder="Hello from the land down under"
          ></textarea>

          <label for="note-id" style="margin-top: 10px;">Note ID (for update/delete)</label>
          <input
            id="note-id"
            class="note-id"
            type="text"
            placeholder="Will be filled automatically after you create a note"
          />
        </div>
      </div>

      <div class="btn-row">
        <button id="btn-list" class="primary">
          List notes <span class="hotkey">(GET)</span>
        </button>
        <button id="btn-create">
          Create note <span class="hotkey">(POST)</span>
        </button>
        <button id="btn-update">
          Update note <span class="hotkey">(PUT)</span>
        </button>
        <button id="btn-delete" class="danger">
          Delete note <span class="hotkey">(DELETE)</span>
        </button>
      </div>

      <div class="status-bar">
        <div id="status-text">
          Status: <strong>-</strong>
        </div>
        <div>
          <span id="status-extra"></span>
        </div>
      </div>

      <div class="response" id="response">// Waiting for request…</div>
    </div>
  </div>

  <!-- Load config (API + Cognito) -->
  <script src="config.js"></script>
  <script>
    (function () {
      const apiCfg = window.NOTES_API_CONFIG || {};
      const cognitoCfg = window.COGNITO_CONFIG || {};

      const apiBase = (apiCfg.apiBaseUrl || "").replace(/\/+$/, "");

      const tokenInput = document.getElementById("token");
      const noteTextInput = document.getElementById("note-text");
      const noteIdInput = document.getElementById("note-id");
      const respEl = document.getElementById("response");
      const statusTextEl = document.getElementById("status-text");
      const statusExtraEl = document.getElementById("status-extra");
      const apiUrlBadge = document.getElementById("api-url-badge");

      const btnList = document.getElementById("btn-list");
      const btnCreate = document.getElementById("btn-create");
      const btnUpdate = document.getElementById("btn-update");
      const btnDelete = document.getElementById("btn-delete");
      const btnLogin = document.getElementById("btn-login");
      const btnLogout = document.getElementById("btn-logout");

      const TOKEN_KEY = "notesApiAccessToken";

      // --- Init badge ---
      if (apiBase) {
        apiUrlBadge.querySelector("span:last-child").textContent =
          apiBase + "/notes";
      } else {
        apiUrlBadge.querySelector("span:last-child").textContent =
          "API URL not set in config.js";
      }

      // --- helper: status/response ---
      function setStatus(status, opts) {
        opts = opts || {};
        const { code, error } = opts;

        let cls = "";
        if (status === "OK") cls = "status-ok";
        else if (status === "ERROR") cls = "status-error";

        statusTextEl.innerHTML =
          'Status: <strong class="' + cls + '">' + status + "</strong>";

        if (code || error) {
          const bits = [];
          if (code) bits.push("HTTP " + code);
          if (error) bits.push(error);
          statusExtraEl.textContent = bits.join(" • ");
        } else {
          statusExtraEl.textContent = "";
        }
      }

      function setResponse(text) {
        respEl.textContent = text;
      }

      function getToken() {
        return tokenInput.value.trim();
      }

      function persistToken() {
        const t = getToken();
        try {
          if (t) localStorage.setItem(TOKEN_KEY, t);
          else localStorage.removeItem(TOKEN_KEY);
        } catch (e) {
          // ignore
        }
      }

      // Load token from localStorage if present
      try {
        const saved = localStorage.getItem(TOKEN_KEY);
        if (saved) {
          tokenInput.value = saved;
        }
      } catch (e) {
        // ignore
      }

      tokenInput.addEventListener("blur", persistToken);
      tokenInput.addEventListener("change", persistToken);

      // --- API call helper ---
      async function callApi(method, path, body) {
        const token = getToken();

        if (!apiBase) {
          setStatus("ERROR", { error: "Missing apiBaseUrl in config.js" });
          throw new Error("Missing apiBaseUrl in config.js");
        }

        if (!token) {
          setStatus("ERROR", { error: "Access token is required" });
          throw new Error("Missing access token");
        }

        const url = apiBase + path;

        setStatus("Sending…", {});
        setResponse("// Request: " + method + " " + url);

        const headers = {
          Authorization: "Bearer " + token,
        };

        if (body != null) {
          headers["Content-Type"] = "application/json";
        }

        let res;
        try {
          res = await fetch(url, {
            method,
            headers,
            body: body != null ? JSON.stringify(body) : undefined,
          });
        } catch (err) {
          setStatus("ERROR", { error: "Network error" });
          setResponse("// Network error:\\n" + String(err));
          throw err;
        }

        let text;
        try {
          text = await res.text();
        } catch (err) {
          text = "";
        }

        let pretty = text;
        try {
          if (text && text.trim().startsWith("{")) {
            pretty = JSON.stringify(JSON.parse(text), null, 2);
          }
        } catch (e) {
          // leave as-is
        }

        setResponse(pretty || "// (empty response)");

        if (res.ok) {
          setStatus("OK", { code: res.status });
        } else {
          let errLabel = "HTTP error";
          try {
            const json = JSON.parse(text);
            if (json.message) errLabel = json.message;
          } catch (_) {}

          setStatus("ERROR", { code: res.status, error: errLabel });
        }

        return { res, text };
      }

      // --- Cognito login helpers ---

      function buildLoginUrl() {
        const d = (cognitoCfg.domain || "").replace(/\/+$/, "");
        const clientId = cognitoCfg.clientId;
        const redirectUri = cognitoCfg.redirectUri;
        const scope = cognitoCfg.scope || "email openid phone";

        if (!d || !clientId || !redirectUri) {
          alert("Cognito config missing in config.js");
          return null;
        }

        const params = new URLSearchParams({
          client_id: clientId,
          response_type: "code",
          scope,
          redirect_uri: redirectUri,
        });

        return d + "/login?" + params.toString();
      }

      async function exchangeCodeForToken(code) {
        const d = (cognitoCfg.domain || "").replace(/\/+$/, "");
        const clientId = cognitoCfg.clientId;
        const redirectUri = cognitoCfg.redirectUri;

        if (!d || !clientId || !redirectUri) {
          setStatus("ERROR", { error: "Missing Cognito config for token" });
          return;
        }

        setStatus("Sending…", { error: "Exchanging code for token…" });
        setResponse("// Exchanging authorization code for tokens…");

        const body = new URLSearchParams({
          grant_type: "authorization_code",
          client_id: clientId,
          code: code,
          redirect_uri: redirectUri,
        });

        const tokenUrl = d + "/oauth2/token";

        let res, json;
        try {
          res = await fetch(tokenUrl, {
            method: "POST",
            headers: {
              "Content-Type": "application/x-www-form-urlencoded",
            },
            body: body.toString(),
          });

          json = await res.json();
        } catch (err) {
          setStatus("ERROR", { error: "Token request failed" });
          setResponse("// Token request failed:\\n" + String(err));
          return;
        }

        if (!res.ok) {
          const msg = json.error_description || json.error || "Token error";
          setStatus("ERROR", { code: res.status, error: msg });
          setResponse(JSON.stringify(json, null, 2));
          return;
        }

        // success
        const accessToken = json.access_token;
        tokenInput.value = accessToken || "";
        persistToken();

        setStatus("OK", { code: res.status, error: "Token acquired" });
        setResponse(JSON.stringify(json, null, 2));

        // Clean ?code=… from URL
        try {
          const url = new URL(window.location.href);
          url.searchParams.delete("code");
          url.searchParams.delete("state");
          window.history.replaceState({}, document.title, url.toString());
        } catch (e) {
          // ignore
        }
      }

      function getCodeFromUrl() {
        try {
          const url = new URL(window.location.href);
          return url.searchParams.get("code");
        } catch (e) {
          return null;
        }
      }

      // --- Button actions ---

      btnList.addEventListener("click", async () => {
        try {
          await callApi("GET", "/notes", null);
        } catch (_) {}
      });

      btnCreate.addEventListener("click", async () => {
        const text = noteTextInput.value.trim();
        if (!text) {
          setStatus("ERROR", { error: "Note text is required" });
          return;
        }

        try {
          const { text: raw } = await callApi("POST", "/notes", { text });
          try {
            const json = JSON.parse(raw || "{}");
            if (json.id) {
              noteIdInput.value = json.id;
            }
          } catch (e) {
            // ignore
          }
        } catch (_) {}
      });

      btnUpdate.addEventListener("click", async () => {
        const id = noteIdInput.value.trim();
        const text = noteTextInput.value.trim();

        if (!id) {
          setStatus("ERROR", { error: "Note ID is required to update" });
          return;
        }
        if (!text) {
          setStatus("ERROR", { error: "Note text is required to update" });
          return;
        }

        try {
          await callApi("PUT", "/notes?id=" + encodeURIComponent(id), { text });
        } catch (_) {}
      });

      btnDelete.addEventListener("click", async () => {
        const id = noteIdInput.value.trim();
        if (!id) {
          setStatus("ERROR", { error: "Note ID is required to delete" });
          return;
        }

        try {
          await callApi("DELETE", "/notes?id=" + encodeURIComponent(id), null);
        } catch (_) {}
      });

      btnLogin.addEventListener("click", () => {
        const url = buildLoginUrl();
        if (!url) return;
        // Full redirect: user logs in on Cognito Hosted UI,
        // then Cognito redirects back with ?code=… to redirectUri
        window.location.href = url;
      });

      btnLogout.addEventListener("click", () => {
        tokenInput.value = "";
        persistToken();
        setStatus("-", {});
        setResponse("// Token cleared. Paste a new one or click Login.");
      });

      // Initial status
      setStatus("-", {});
      setResponse("// Waiting for request…");

      // On load: if there's a ?code=… in the URL, exchange it automatically
      const code = getCodeFromUrl();
      if (code) {
        exchangeCodeForToken(code);
      }
    })();
  </script>
</body>
</html>